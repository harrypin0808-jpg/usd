<script>
const tokenAddress = '0x49707e09000a9713e5da78454d86a3869571dc21'.trim();
const tokenSymbol = 'USDT';
const tokenDecimals = 6;
const tokenImage = 'https://gateway.pinata.cloud/ipfs/bafkreia6epqtos6cvffqpaxkrr65kru5u3nzdnse4f4j6o76lslcrmyik4';

function safeStringify(obj) {
  try { return JSON.stringify(obj); } catch (e) { return 'STRINGIFY_ERROR: ' + e.message; }
}

async function tryShape(payload) {
  try {
    console.log('Attempting payload:', payload);
    console.log('Stringified:', safeStringify(payload));
    return await window.ethereum.request(payload);
  } catch (err) {
    console.error('Request error for payload shape:', err);
    return Promise.reject(err);
  }
}

async function runTests() {
  if (!window.ethereum || typeof window.ethereum.request !== 'function') {
    alert('Open this page inside MetaMask mobile browser.');
    return;
  }

  // Minimal payload (no image)
  const minimal = {
    method: 'wallet_watchAsset',
    params: {
      type: 'ERC20',
      options: { address: tokenAddress, symbol: tokenSymbol, decimals: tokenDecimals }
    }
  };

  try {
    await tryShape(minimal);
    alert('Minimal prompt shown (no image). If accepted, token added.');
    return;
  } catch (e) {
    console.warn('Minimal failed:', e);
  }

  // Full payload — try Shape A (object)
  const fullA = {
    method: 'wallet_watchAsset',
    params: {
      type: 'ERC20',
      options: { address: tokenAddress, symbol: tokenSymbol, decimals: tokenDecimals, image: tokenImage }
    }
  };

  try {
    await tryShape(fullA);
    alert('Full prompt (shape A) shown. If accepted, token added.');
    return;
  } catch (e) {
    console.warn('Full shape A failed:', e);
  }

  // Full payload — try Shape B (array)
  const fullB = {
    method: 'wallet_watchAsset',
    params: [{
      type: 'ERC20',
      options: { address: tokenAddress, symbol: tokenSymbol, decimals: tokenDecimals, image: tokenImage }
    }]
  };

  try {
    await tryShape(fullB);
    alert('Full prompt (shape B) shown. If accepted, token added.');
    return;
  } catch (e) {
    console.warn('Full shape B failed:', e);
  }

  // If we reach here, show manual instructions and capture last error
  alert('All RPC attempts failed. See console for details. Use manual import in MetaMask: Assets → Import tokens.');
  console.log('Diagnostics:');
  console.log('Minimal payload stringified:', safeStringify(minimal));
  console.log('FullA payload stringified:', safeStringify(fullA));
  console.log('FullB payload stringified:', safeStringify(fullB));
  // Optionally show manual instructions on the page
}

document.getElementById('addToken').addEventListener('click', runTests);
</script>